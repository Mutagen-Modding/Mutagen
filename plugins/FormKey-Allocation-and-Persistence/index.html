<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mutagen-modding.github.io/Mutagen/plugins/FormKey-Allocation-and-Persistence/">
      
      
        <link rel="prev" href="../Bethesda-Format-Abstraction/">
      
      
        <link rel="next" href="../other-utility/">
      
      
      <link rel="icon" href="../../mutagen-icon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>FormKey Allocation and Persistence - Mutagen Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mapping-records-via-editorid" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Mutagen Documentation" class="md-header__button md-logo" aria-label="Mutagen Documentation" data-md-component="logo">
      
  <img src="../../mutagen-icon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Mutagen Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              FormKey Allocation and Persistence
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Mutagen-Modding/Mutagen" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
  </div>
  <div class="md-source__repository">
    Mutagen
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Mutagen Documentation" class="md-nav__button md-logo" aria-label="Mutagen Documentation" data-md-component="logo">
      
  <img src="../../mutagen-icon.png" alt="logo">

    </a>
    Mutagen Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Mutagen-Modding/Mutagen" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
  </div>
  <div class="md-source__repository">
    Mutagen
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Big-Cheat-Sheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Big Cheat Sheet
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Plugin Record Suite
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Plugin Record Suite
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ModKey%2C%20FormKey%2C%20FormLink/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ModKey, FormKey, FormLink
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Importing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Importing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../New-Mods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    New Mods
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Exporting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exporting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Interfaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interfaces (Aspect/Link/Getters)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Copy-Functionality/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Copy Functionality
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Equality-Checks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Equality Checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Translation-Masks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Translation Masks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Flags-and-Enums/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flags and Enums
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AssetLink/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Asset Links
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Compaction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compaction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Create%2C-Duplicate%2C-and-Override/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Create, Duplicate, and Override
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Remapping-FormLinks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Remapping FormLinks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Printing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Printing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Abstract-Subclassing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Abstract Subclassing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Exceeding-Master-Limits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exceeding Master Limits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_18">
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../specific/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Specific Records
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_18" id="__nav_3_18_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_18">
            <span class="md-nav__icon md-icon"></span>
            Specific Records
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../specific/ExtraData/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ExtraData
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../specific/Globals-And-GameSettings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Globals and GameSettings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_18_4">
        
          
          <label class="md-nav__link" for="__nav_3_18_4" id="__nav_3_18_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Oblivion
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_18_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_18_4">
            <span class="md-nav__icon md-icon"></span>
            Oblivion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../game-specific/oblivion/Oblivion-Aspect-Interfaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Oblivion Aspect Interfaces
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../game-specific/oblivion/Oblivion-Link-Interfaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Oblivion Link Interfaces
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_18_5">
        
          
          <label class="md-nav__link" for="__nav_3_18_5" id="__nav_3_18_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Skyrim
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_18_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_18_5">
            <span class="md-nav__icon md-icon"></span>
            Skyrim
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../game-specific/skyrim/Skyrim-Perks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Skyrim Perks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../game-specific/skyrim/Skyrim-Aspect-Interfaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Skyrim Aspect Interfaces
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../game-specific/skyrim/Skyrim-Link-Interfaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Skyrim Link Interfaces
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bethesda-Format-Abstraction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bethesda Format Abstraction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    FormKey Allocation and Persistence
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    FormKey Allocation and Persistence
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mapping-records-via-editorid" class="md-nav__link">
    <span class="md-ellipsis">
      Mapping Records Via EditorID
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keep-editorids-unique" class="md-nav__link">
    <span class="md-ellipsis">
      Keep EditorIDs Unique
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mixing-editorid-and-blind-allocations" class="md-nav__link">
    <span class="md-ellipsis">
      Mixing EditorID and Blind Allocations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mixing EditorID and Blind Allocations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-collision-avoidance-works" class="md-nav__link">
    <span class="md-ellipsis">
      How Collision Avoidance Works
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-scenario" class="md-nav__link">
    <span class="md-ellipsis">
      Example Scenario
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simpleformkeyallocator-caveat" class="md-nav__link">
    <span class="md-ellipsis">
      SimpleFormKeyAllocator Caveat
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#persistence-and-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      Persistence and Allocation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Persistence and Allocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-a-mods-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      Setting a Mod's Allocator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-file-allocators" class="md-nav__link">
    <span class="md-ellipsis">
      Text File Allocators
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Text File Allocators">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#textfileformkeyallocator" class="md-nav__link">
    <span class="md-ellipsis">
      TextFileFormKeyAllocator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#textfilesharedformkeyallocator" class="md-nav__link">
    <span class="md-ellipsis">
      TextFileSharedFormKeyAllocator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sqlite" class="md-nav__link">
    <span class="md-ellipsis">
      Sqlite
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saving-allocation-state" class="md-nav__link">
    <span class="md-ellipsis">
      Saving Allocation State
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../other-utility/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Other Utility
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4">
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../environment/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Environment
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Environment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../environment/Environment-Construction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Environment Construction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../environment/Game-Locations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Game Locations
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5">
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../linkcache/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Link Cache
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Link Cache
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linkcache/Record-Resolves/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Record Resolves
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linkcache/Scoping-Type/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scoping Type
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linkcache/ModContexts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mod Contexts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linkcache/Previous-Override-Iteration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Previous Override Iteration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6">
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../loadorder/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Load Order
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Load Order
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../loadorder/Winning-Overrides/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Winning Override Iteration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Archives/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Archives (BSAs)
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Strings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Strings
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9">
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Getting Familiar with C#
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Getting Familiar with C#
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../familiar/Namespaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Namespaces
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../familiar/Nullability-to-Indicate-Record-Presence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nullability to Indicate Record Presence
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10">
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Best Practices
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Best Practices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/Read-Only/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prefer Readonly Types
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/Accessing-Known-Records/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accessing Known Records
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/FormLinks-Target-Getter-Interfaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FormLinks Target Getter Interfaces
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/FormLinks-vs-EditorID-as-Identifiers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FormLinks vs EditorID as Identifiers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/FormLink-Nullability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FormLink Nullability
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/Enumerable-Laziness/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Enumerable Laziness
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/TryGet-Concepts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TryGet Concepts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/Overlays-Single-Access/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Access Overlays Once
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/ITPO-Avoidance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ITPO Avoidance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/Reuse-Translation-Masks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reuse Translation Masks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/Modifying-Groups-Being-Iterated/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modifying Groups Being Iterated
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/Enrich-Exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Enriching Exceptions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../best-practices/Mo2-Compatibility/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mo2 Compatibility
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11">
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../wpf/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    WPF Library
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11" id="__nav_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            WPF Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wpf/FormKey-Picker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FormKey Picker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wpf/ModKey-Picker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ModKey Picker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wpf/Reflection-Powered-Settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reflection Powered Settings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wpf/Adding-Required-Resources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Adding Required Resources
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Json/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Json
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13">
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../lowlevel/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Low Level Tools
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_13" id="__nav_13_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Low Level Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lowlevel/C%23-Span/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C# Span
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lowlevel/Header-Structs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Header Structs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lowlevel/Game-Constants/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Game Constants
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lowlevel/Binary-Streams/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binary Streams
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lowlevel/Binary-Utility/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binary Utility
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Correctness/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Correctness
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mapping-records-via-editorid" class="md-nav__link">
    <span class="md-ellipsis">
      Mapping Records Via EditorID
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keep-editorids-unique" class="md-nav__link">
    <span class="md-ellipsis">
      Keep EditorIDs Unique
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mixing-editorid-and-blind-allocations" class="md-nav__link">
    <span class="md-ellipsis">
      Mixing EditorID and Blind Allocations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mixing EditorID and Blind Allocations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-collision-avoidance-works" class="md-nav__link">
    <span class="md-ellipsis">
      How Collision Avoidance Works
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-scenario" class="md-nav__link">
    <span class="md-ellipsis">
      Example Scenario
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simpleformkeyallocator-caveat" class="md-nav__link">
    <span class="md-ellipsis">
      SimpleFormKeyAllocator Caveat
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#persistence-and-allocation" class="md-nav__link">
    <span class="md-ellipsis">
      Persistence and Allocation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Persistence and Allocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-a-mods-allocator" class="md-nav__link">
    <span class="md-ellipsis">
      Setting a Mod's Allocator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-file-allocators" class="md-nav__link">
    <span class="md-ellipsis">
      Text File Allocators
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Text File Allocators">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#textfileformkeyallocator" class="md-nav__link">
    <span class="md-ellipsis">
      TextFileFormKeyAllocator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#textfilesharedformkeyallocator" class="md-nav__link">
    <span class="md-ellipsis">
      TextFileSharedFormKeyAllocator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sqlite" class="md-nav__link">
    <span class="md-ellipsis">
      Sqlite
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saving-allocation-state" class="md-nav__link">
    <span class="md-ellipsis">
      Saving Allocation State
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>FormKey Allocation and Persistence</h1>

<div class="admonition danger">
<p class="admonition-title">Experimental</p>
<p>This feature has had some work put into it, but is still an experimental proof of concept</p>
</div>
<p>It is common that tooling that is generating new records when creating plugins wants to keep their FormKeys consistent across several runs.  The same records should get the same FormKeys.</p>
<p>There are some challenges with fulfilling this:</p>
<ul>
<li>How is a record detected to be the "same" as one from a previous run?</li>
<li>Where/How do you persist the mapping information between runs?</li>
</ul>
<h2 id="mapping-records-via-editorid">Mapping Records Via EditorID</h2>
<p>One of the challenges is finding a way to map records from a previous run with records from the current run, so that their FormKeys can be synced.  Mutagen does this by requiring the developer provide a unique EditorID when they want syncing to occur.</p>
<p>Mutagen offers a few ways to hook into its allocation API.
</p><div class="highlight"><pre><span></span><code><span class="c1">// No EditorID is provided at time of creation, so no syncing features invoked</span>
<span class="kt">var</span><span class="w"> </span><span class="n">unsyncedNpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">Npcs</span><span class="p">.</span><span class="n">AddNew</span><span class="p">();</span>

<span class="c1">// EditorID is provided, so FormKey syncing features are active for this record</span>
<span class="kt">var</span><span class="w"> </span><span class="n">syncedNpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">Npcs</span><span class="p">.</span><span class="n">AddNew</span><span class="p">(</span><span class="s">"SomeUniqueEdid"</span><span class="p">);</span>

<span class="c1">// Some more routes</span>
<span class="kt">var</span><span class="w"> </span><span class="n">syncedNpc2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Npc</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="s">"SomeThirdEdid"</span><span class="p">);</span>
<span class="kt">var</span><span class="w"> </span><span class="n">syncedNpc3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Npc</span><span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">GetNextFormKey</span><span class="p">(</span><span class="s">"SomeOtherEdid"</span><span class="p">));</span>
</code></pre></div><p></p>
<p>For the records where the EditorID was provided at the time of creation, syncing functionality will be applied if enabled (more on this later).</p>
<h2 id="keep-editorids-unique">Keep EditorIDs Unique</h2>
<p>With this pattern, the burden is on the developer to ensure that all records created in this fashion are supplied unique EditorIDs.  If new record is made with an EditorID that has already been used in the current "run", then an exception will be thrown.</p>
<p>It is recommended to name the EditorIDs off the aspects that drove the record to be made in the first place:</p>
<p><code>MyMod_GlassArmorNoviceShockEnchantment</code></p>
<p><code>MyMod_GlassArmorMasterShockEnchantment</code></p>
<p>Since each is named with a specific "goal" in mind, it will be less likely to collide.</p>
<h2 id="mixing-editorid-and-blind-allocations">Mixing EditorID and Blind Allocations</h2>
<p>A common question is what happens when some records are created with EditorIDs (for synchronization) while others are created without (blind allocation). Will there be collisions?</p>
<h3 id="how-collision-avoidance-works">How Collision Avoidance Works</h3>
<p>Persistent allocators (<code>TextFileFormKeyAllocator</code>, <code>TextFileSharedFormKeyAllocator</code>, <code>SQLiteFormKeyAllocator</code>) track <strong>all</strong> allocated FormIDs internally, regardless of whether they were allocated with an EditorID or not. When a blind allocation is requested, the allocator:</p>
<ol>
<li>Starts with the mod's <code>NextFormID</code> as a candidate</li>
<li>Checks if that FormID is already in use (from the persistence file or previous allocations)</li>
<li>If in use, increments and checks again until finding an unused FormID</li>
<li>Returns the unused FormID</li>
</ol>
<p>This means blind allocations will automatically skip over any FormIDs that were previously assigned to EditorID-based records. There is no risk of a blind allocation "stealing" a FormKey that the allocator had reserved for a specific EditorID.</p>
<h3 id="example-scenario">Example Scenario</h3>
<p>Consider this workflow:
</p><div class="highlight"><pre><span></span><code><span class="c1">// Run 1: Create records with EditorIDs</span>
<span class="kt">var</span><span class="w"> </span><span class="n">npc1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">Npcs</span><span class="p">.</span><span class="n">AddNew</span><span class="p">(</span><span class="s">"MyMod_ImportantNpc"</span><span class="p">);</span><span class="w">  </span><span class="c1">// Gets FormID 0x800</span>
<span class="kt">var</span><span class="w"> </span><span class="n">npc2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">Npcs</span><span class="p">.</span><span class="n">AddNew</span><span class="p">(</span><span class="s">"MyMod_AnotherNpc"</span><span class="p">);</span><span class="w">    </span><span class="c1">// Gets FormID 0x801</span>
<span class="c1">// Allocator persists: "MyMod_ImportantNpc" -&gt; 0x800, "MyMod_AnotherNpc" -&gt; 0x801</span>

<span class="c1">// Run 2: Mix of EditorID and blind allocations</span>
<span class="kt">var</span><span class="w"> </span><span class="n">npc1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">Npcs</span><span class="p">.</span><span class="n">AddNew</span><span class="p">(</span><span class="s">"MyMod_ImportantNpc"</span><span class="p">);</span><span class="w">  </span><span class="c1">// Returns 0x800 (from persistence)</span>
<span class="kt">var</span><span class="w"> </span><span class="n">tempNpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">Npcs</span><span class="p">.</span><span class="n">AddNew</span><span class="p">();</span><span class="w">                    </span><span class="c1">// Gets 0x802 (skips 0x800, 0x801)</span>
<span class="kt">var</span><span class="w"> </span><span class="n">npc2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">Npcs</span><span class="p">.</span><span class="n">AddNew</span><span class="p">(</span><span class="s">"MyMod_AnotherNpc"</span><span class="p">);</span><span class="w">    </span><span class="c1">// Returns 0x801 (from persistence)</span>
<span class="kt">var</span><span class="w"> </span><span class="n">anotherTemp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">Npcs</span><span class="p">.</span><span class="n">AddNew</span><span class="p">();</span><span class="w">                </span><span class="c1">// Gets 0x803</span>
</code></pre></div><p></p>
<p>The blind allocations never interfere with the EditorID-mapped FormKeys, even if they're requested in a different order than the original run.</p>
<h3 id="simpleformkeyallocator-caveat">SimpleFormKeyAllocator Caveat</h3>
<p>Note that <code>SimpleFormKeyAllocator</code> (the default non-persistent allocator) does <strong>not</strong> provide this collision avoidance. It simply increments the mod's <code>NextFormID</code> sequentially. If you need to mix EditorID and blind allocations safely across runs, use one of the persistent allocators.</p>
<h2 id="persistence-and-allocation">Persistence and Allocation</h2>
<p>The other half that needs to be considered is where the mapping information is stored, and how that data gets imported/used to fulfill the allocation requests described above.</p>
<h3 id="setting-a-mods-allocator">Setting a Mod's Allocator</h3>
<p>Every mod can have its FormKey allocator set, which is the logic that hands out new FormKeys to records.  This where a FormKey syncing allocator can be injected with whatever behavior we wish.</p>
<p></p><div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SkyrimMod</span><span class="p">(...);</span>
<span class="kt">var</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TextFileFormKeyAllocator</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">pathToFile</span><span class="p">);</span>
<span class="n">mod</span><span class="p">.</span><span class="n">SetAllocator</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>
</code></pre></div>
This would set the mod to sync its FormKeys to a text file at the given path.<p></p>
<h3 id="text-file-allocators">Text File Allocators</h3>
<p>These alloctors save their data into a text file with the following format:
</p><div class="highlight"><pre><span></span><code>TheEditorIdToSyncAgainst
123456
[...Repeat...]
</code></pre></div><p></p>
<p>One thing of note is that it saves just the FormID, without the mod indices.  The ModKey to be associated with is not persisted in the file itself.</p>
<h4 id="textfileformkeyallocator">TextFileFormKeyAllocator</h4>
<p>This a simplistic 1:1 allocator from a single mod to a single file.  As such, the ModKey of the mod is combined with the FormID retrieved from the file to get the actual FormKey for use.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SkyrimMod</span><span class="p">(...);</span>
<span class="kt">var</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TextFileFormKeyAllocator</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">pathToFile</span><span class="p">);</span>
<span class="n">mod</span><span class="p">.</span><span class="n">SetAllocator</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>
</code></pre></div>
<h4 id="textfilesharedformkeyallocator">TextFileSharedFormKeyAllocator</h4>
<p>This is a more advanced allocator for when several separate sources need to coordinate together to avoid FormKey collisions.  A prime example is a Synthesis patcher run, where several separate programs will run, and all need to avoid allocating FormKeys that another has used.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SkyrimMod</span><span class="p">(...);</span>
<span class="kt">var</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TextFileSharedFormKeyAllocator</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">pathToFolder</span><span class="p">,</span><span class="w"> </span><span class="s">"MyProgramName"</span><span class="p">);</span>
<span class="n">mod</span><span class="p">.</span><span class="n">SetAllocator</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>
</code></pre></div>
<p>This will save to a folder, instead, with a file within under "MyProgramName" that has this specific programs sync information.  However, the system will examine other files within that folder so that those FormKeys can be avoided when allocating fresh new FormKeys.</p>
<h4 id="sqlite">Sqlite</h4>
<p>There is also the beginnings of a Sqlite backed persistence system within <code>Mutagen.Bethesda.Sqlite</code>.  It needs to be optimized before it will be a viable choice.</p>
<h3 id="saving-allocation-state">Saving Allocation State</h3>
<p>Allocators are created separately from a mod, even if they are assigned to a mod and tightly associated with it.  As such, allocators are themselves in charge of persisting their state once allocations have been made.  Typically this is done via disposal mechanics:</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span><span class="w"> </span><span class="n">mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SkyrimMod</span><span class="p">(...);</span>
<span class="c1">// This API pattern will dispose the allocator when its variable goes out of scope</span>
<span class="k">using</span><span class="w"> </span><span class="nn">var</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TextFileFormKeyAllocator</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">pathToFile</span><span class="p">);</span>
<span class="n">mod</span><span class="p">.</span><span class="n">SetAllocator</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>

<span class="c1">// Or</span>
<span class="kt">var</span><span class="w"> </span><span class="n">mod2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SkyrimMod</span><span class="p">(...);</span>
<span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">allocator2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TextFileFormKeyAllocator</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">pathToFile</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">mod2</span><span class="p">.</span><span class="n">SetAllocator</span><span class="p">(</span><span class="n">allocator2</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Do work on mod</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// Allocator exports results to disk here</span>

<span class="c1">// Or</span>
<span class="kt">var</span><span class="w"> </span><span class="n">mod3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SkyrimMod</span><span class="p">(...);</span>
<span class="kt">var</span><span class="w"> </span><span class="n">allocator3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TextFileFormKeyAllocator</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">pathToFile</span><span class="p">)</span>
<span class="n">mod3</span><span class="p">.</span><span class="n">SetAllocator</span><span class="p">(</span><span class="n">allocator3</span><span class="p">);</span>

<span class="c1">// Do work on mod</span>
<span class="c1">// Manually dispose or persist allocator when done</span>
<span class="n">allocator3</span><span class="p">.</span><span class="n">Commit</span><span class="p">();</span><span class="w"> </span><span class="c1">// Or Dispose</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/Mutagen-Modding" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://discord.gg/GdKZ3SH" target="_blank" rel="noopener" title="discord.gg" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485.065 485.065 0 0 0 404.081 32.03a1.816 1.816 0 0 0-1.923.91 337.461 337.461 0 0 0-14.9 30.6 447.848 447.848 0 0 0-134.426 0 309.541 309.541 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.689 483.689 0 0 0-119.688 37.107 1.712 1.712 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016 0 0 0 .765 1.375 487.666 487.666 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348.2 348.2 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321.173 321.173 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251.047 251.047 0 0 0 9.109-7.137 1.819 1.819 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.812 1.812 0 0 1 1.924.233 234.533 234.533 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.407 301.407 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391.055 391.055 0 0 0 30.014 48.815 1.864 1.864 0 0 0 2.063.7A486.048 486.048 0 0 0 610.7 405.729a1.882 1.882 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541ZM222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241Zm195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241Z"></path></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.tooltips", "content.code.copy", "navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.path"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>